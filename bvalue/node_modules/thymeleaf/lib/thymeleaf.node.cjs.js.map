{"version":3,"file":"thymeleaf.node.cjs.js","sources":["../source/processors/AttributeProcessor.js","../source/standard/processors/AttrAttributeProcessor.js","../source/processors/ElementProcessor.js","../source/utilities/Dom.js","../source/standard/processors/BlockElementProcessor.js","../source/standard/processors/CheckedAttributeProcessor.js","../source/standard/processors/ClassAppendAttributeProcessor.js","../source/standard/processors/EachAttributeProcessor.js","../source/standard/processors/EmptyableAttributeProcessor.js","../source/standard/processors/FragmentAttributeProcessor.js","../source/standard/processors/IfAttributeProcessor.js","../source/utilities/Fragments.js","../source/standard/processors/InsertAttributeProcessor.js","../source/standard/processors/RemovableAttributeProcessor.js","../source/standard/processors/RemoveAttributeProcessor.js","../source/standard/processors/ReplaceAttributeProcessor.js","../source/utilities/Messages.js","../source/standard/processors/TextAttributeProcessor.js","../source/standard/processors/UnlessAttributeProcessor.js","../source/standard/processors/UTextAttributeProcessor.js","../source/standard/processors/WithAttributeProcessor.js","../source/standard/processors/XmlNsAttributeProcessor.js","../source/dialects/Dialect.js","../source/standard/StandardDialect.js","../source/Configurations.js","../source/processors/Matcher.js","../source/parser/InputBuffer.js","../source/parser/Parser.js","../source/standard/expressions/ExpressionProcessor.js","../source/standard/expressions/AllInput.js","../source/parser/Rule.js","../source/standard/expressions/ThymeleafRule.js","../source/parser/Grammar.js","../source/parser/Operators.js","../source/standard/expressions/FragmentSignatureGrammar.js","../source/parser/RegularExpression.js","../source/utilities/getByPath.js","../source/standard/expressions/ThymeleafExpressionLanguage.js","../source/utilities/Functions.js","../source/TemplateEngine.js"],"sourcesContent":["/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Common class for attribute processors.\n * \n * @author Emanuel Rabina\n */\nexport default class AttributeProcessor {\n\n\t/**\n\t * Constructor, sets this processor's prefix and name.\n\t * \n\t * @param {String} prefix\n\t * @param {String} name\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, name, isomorphic) {\n\n\t\tthis.prefix     = prefix;\n\t\tthis.name       = name;\n\t\tthis.isomorphic = isomorphic;\n\t}\n\n\t/**\n\t * Process the given attribute on the element it appears.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} Whether or not the parent tree needs reprocessing because\n\t *   of modifications made by the processor.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\telement.removeAttribute(attribute);\n\t\tif (this.isomorphic) {\n\t\t\telement.removeAttribute(`${this.prefix}:${this.name}`);\n\t\t}\n\t\treturn false;\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nimport {escapeHtml} from '@ultraq/string-utils';\n\nexport const NAME = 'attr';\n\n/**\n * JS equivalent of Thymeleaf's `th:attr` attribute processor, modifies or sets\n * a target attribute to whatever its associated expression evaluates to.\n * \n * @author Emanuel Rabina\n */\nexport default class AttrAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `attr` name and supplied prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:attr` or `data-th-attr` attribute\n\t * on it, picking out the target attributes and setting them to whatever their\n\t * expressions evaluate to.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\t// TODO: This regex, is this some kind of value list that needs to be\n\t\t//       turned into an expression?\n\t\tif (/(.+=.+,)*.+=.+/.test(attributeValue)) {\n\t\t\tattributeValue.split(',').forEach(attribute => {\n\t\t\t\tlet [name, value] = attribute.split('=');\n\t\t\t\tlet processorResult = context.expressionProcessor.process(value, context);\n\t\t\t\telement.setAttribute(name, escapeHtml(\n\t\t\t\t\ttypeof processorResult === 'string' ?\n\t\t\t\t\t\tprocessorResult :\n\t\t\t\t\t\tJSON.stringify(processorResult))\n\t\t\t\t);\n\t\t\t});\n\t\t}\n\t\t/* istanbul ignore next */\n\t\telse if (process.env.NODE_ENV !== 'test') {\n\t\t\tconsole.warn(`Value to ${attribute}, ${attributeValue}, doesn't seem to contain an attribute assignment expression.  Ignoring.`);\n\t\t}\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n","/* \n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Parent class for element processors.\n * \n * @author Emanuel Rabina\n */\nexport default class ElementProcessor {\n\n\t/**\n\t * Constructor, sets this processor's prefix and name.\n\t * \n\t * @param {String} prefix\n\t * @param {String} name\n\t */\n\tconstructor(prefix, name) {\n\n\t\tthis.prefix = prefix;\n\t\tthis.name   = name;\n\t}\n\n\t/**\n\t * Processes the given element.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {Object} context\n\t * @return {Boolean} Whether or not the parent tree needs reprocessing because\n\t *   of modifications made by the processor.\n\t */\n\tprocess(element, context) {\n\n\t\treturn false;\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* global ENVIRONMENT */\nimport {\n\tdeserialize as domDeserialize,\n\tserialize as domSerialize\n}              from '@ultraq/dom-utils';\nimport {JSDOM} from 'jsdom';\n\n// Node.nodeType values, not present outside of a JSDOM environment so can't\n// reference them w/ Node.X\n// For a full list of values, see: https://developer.mozilla.org/en-US/docs/Web/API/Node/nodeType\nexport const NODE_TYPE_DOCUMENT_TYPE = 10;\nexport const NODE_TYPE_ELEMENT = 1;\n\n/**\n * Create and return a new HTML fragment using JSDOM from the given string.\n * Used for tests.\n * \n * @param {String} htmlString\n * @return {Element}\n */\nexport function createHtml(htmlString) {\n\treturn new JSDOM(htmlString).window.document.body.firstElementChild;\n}\n\n/**\n * Returns the value of a Thymeleaf attribute processor.\n * \n * @param {Element} element\n * @param {String} prefix\n * @param {String} processorName\n * @return {String} The value of the Thymeleaf attribute processor, or `null`\n *   if the attribute processor wasn't present.\n */\nexport function getThymeleafAttributeValue(element, prefix, processorName) {\n\treturn element.getAttribute(`${prefix}:${processorName}`) ||\n\t       element.getAttribute(`data-${prefix}-${processorName}`);\n}\n\n/**\n * Use either JSDOM or the browser's native DOM parsing to deserialize the HTML\n * string into a document fragment.\n * \n * @param {String} htmlString\n * @return {DocumentFragment}\n */\nexport function deserialize(htmlString) {\n\t/* istanbul ignore if */\n\tif (ENVIRONMENT === 'browser') {\n\t\treturn domDeserialize(htmlString);\n\t}\n\telse {\n\t\treturn new JSDOM(htmlString).window.document;\n\t}\n}\n\n/**\n * Use either JSDOM or the browser's native DOM serialization to serialize a\n * document fragment into an HTML string.\n * \n * @param {DocumentFragment} documentFragment\n * @return {String}\n */\nexport function serialize(documentFragment) {\n\t/* istanbul ignore if */\n\tif (ENVIRONMENT === 'browser') {\n\t\treturn domSerialize(documentFragment);\n\t}\n\telse {\n\t\tlet result = '';\n\t\tlet {firstChild, firstElementChild} = documentFragment;\n\t\tif (firstChild.nodeType === NODE_TYPE_DOCUMENT_TYPE) {\n\t\t\tresult += `<!DOCTYPE ${firstChild.name}>`;\n\t\t}\n\t\treturn result + firstElementChild.outerHTML;\n\t}\n}\n","/* \n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport ElementProcessor    from '../../processors/ElementProcessor.js';\nimport {NODE_TYPE_ELEMENT} from '../../utilities/Dom.js';\n\nexport const NAME = 'block';\n\n/**\n * Equivalent of Thymeleaf's \"synthetic tag\", `th:block`, which removes itself,\n * leaving the body of the tag behind.\n * \n * @author Emanuel Rabina\n */\nexport default class BlockElementProcessor extends ElementProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `block` name and supplied prefix.\n\t * \n\t * @param {String} prefix\n\t */\n\tconstructor(prefix) {\n\n\t\tsuper(prefix, NAME);\n\t}\n\n\t/**\n\t * Processes an element named `th:block`, removing itself to leave its\n\t * body/contents behind.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {Object} context\n\t * @return {Boolean} `true` to indicate that the elements need reprocessing.\n\t */\n\tprocess(element, context) {\n\n\t\tlet parent = element.parentElement;\n\t\twhile (element.firstChild) {\n\t\t\tlet child = element.firstChild;\n\t\t\tparent.insertBefore(child, element);\n\n\t\t\tif (child.nodeType === NODE_TYPE_ELEMENT && element.__thymeleafLocalVariables) {\n\t\t\t\tchild.__thymeleafLocalVariables = {\n\t\t\t\t\t...(child.__thymeleafLocalVariables || {}),\n\t\t\t\t\t...element.__thymeleafLocalVariables\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\tparent.removeChild(element);\n\n\t\treturn true;\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'checked';\n\n/**\n * Thymeleaf's `th:checked` attribute processor, sets or removes the `checked`\n * attribute from an element based on the result of the expression within it.\n * \n * TODO: This is one of HTML5s \"boolean attributes\", attributes whose values are\n *       true simply by being present in the element, regardless of the value\n *       inside it.  To act as false, the attribute has to be removed.  Find a\n *       way to generate these from some list of boolean attributes so that I\n *       don't need to write a class for each one!\n * \n * @author Emanuel Rabina\n */\nexport default class CheckedAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `checked` name and supplied\n\t * prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:checked` or `data-th-checked`\n\t * attribute on it, either setting or removing a `checked` attribute to the\n\t * current element based on the result of the inner expression.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tlet result = context.expressionProcessor.process(attributeValue, context);\n\t\tif (result) {\n\t\t\telement.setAttribute('checked', '');\n\t\t}\n\t\telse {\n\t\t\telement.removeAttribute('checked');\n\t\t}\n\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'classappend';\n\n/**\n * The `th:classappend` is a special attribute that applies the expression to\n * any existing classes already on an element.\n * \n * @author Emanuel Rabina\n */\nexport default class ClassAppendAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `attr` name and supplied prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:classappend` or `data-th-classappend`\n\t * attribute on it, adding the resulting classes to any existing classes on\n\t * the current element.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tlet classes = context.expressionProcessor.process(attributeValue, context);\n\t\tif (classes) {\n\t\t\telement.className += ` ${classes}`;\n\t\t}\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'each';\n\n/**\n * JS equivalent of Thymeleaf's `th:each` attribute processor, iterates over an\n * [iterable object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols),\n * executing a piece of template for every iteration.\n * \n * @author Emanuel Rabina\n */\nexport default class EachAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `each` name and supplied prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:each`/`data-th-each` attribute,\n\t * repeating the markup for every object in the iterable value.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} Whether or not the parent element needs to do a second\n\t *   pass as its children have been modified by this processor.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tsuper.process(element, attribute, attributeValue, context);\n\n\t\tlet iterationInfo = context.expressionProcessor.process(attributeValue, context);\n\t\tif (iterationInfo) {\n\t\t\tlet {localValueName, iterable} = iterationInfo;\n\t\t\tlet templateNode = element.cloneNode(true);\n\n\t\t\tfor (let value of iterable) {\n\t\t\t\tlet localClone = templateNode.cloneNode(true);\n\t\t\t\tlocalClone.__thymeleafLocalVariables = {\n\t\t\t\t\t[localValueName]: value\n\t\t\t\t};\n\t\t\t\telement.parentElement.appendChild(localClone);\n\t\t\t}\n\t\t}\n\t\telement.parentElement.removeChild(element);\n\n\t\treturn true;\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\n/**\n * Configurable attribute processor that sets or empties an attribute value on\n * an element if the result of its expression is truthy or falsey respectively.\n * \n * @author Emanuel Rabina\n */\nexport default class EmptyableAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set the name of the attribute this processor will operate on.\n\t * \n\t * @param {String} prefix\n\t * @param {String} name\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, name, isomorphic) {\n\n\t\tsuper(prefix, name, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains the configured attribute to be worked\n\t * on, setting it if the expression resolves to a truthy value, or removing it\n\t * if it resolves to a falsey value.\n\t * \n\t * @param {Element} element \n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tlet value = context.expressionProcessor.process(attributeValue, context);\n\t\telement.setAttribute(this.name, value ? value.toString() : '');\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n\nexport const EMPTYABLE_ATTRIBUTE_NAMES = [\n\t'datetime',\n\t'href',\n\t'src',\n\t'style',\n\t'value'\n];\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'fragment';\n\n/**\n * JS equivalent of Thymeleaf's `th:fragment` attribute processor, marks an\n * element as a template fragment that can be imported by other processors like\n * `th:insert`.\n * \n * @author Emanuel Rabina\n */\nexport default class FragmentAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `fragment` name and supplied\n\t * prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'if';\n\n/**\n * JS equivalent of Thymeleaf's `th:if` attribute processor, includes or\n * excludes the current element and its children from rendering, depending on\n * the evaluation of the expression in the attribute value.\n * \n * @author Emanuel Rabina\n */\nexport default class IfAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `if` name and supplied prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:if` or `data-th-if` attribute\n\t * on it, evaluating the expression for truthy/falsey, rendering/excluding the\n\t * element and its children based on the result.\n\t * \n\t * @param {Element} element \n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `true` if the element was removed.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tlet expressionResult = context.expressionProcessor.process(attributeValue, context);\n\t\tif (!expressionResult) {\n\t\t\telement.remove();\n\t\t\treturn true;\n\t\t}\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n","/* \n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {deserialize} from './Dom.js';\nimport {NAME}        from '../standard/processors/FragmentAttributeProcessor.js';\n\nimport {$} from 'dumb-query-selector';\n\n/**\n * Extract HTML from the target identified by the given fragment information.\n * \n * @param {String} dialectPrefix\n * @param {Object} fragmentInfo\n * @param {Object} context\n * @return {Promise<Element>}\n */\nexport async function extractFragment(dialectPrefix, fragmentInfo, context) {\n\tlet {templateResolver} = context;\n\tif (templateResolver) {\n\t\tlet {templateName, fragmentName} = fragmentInfo;\n\t\tlet template = deserialize(await templateResolver(templateName));\n\t\treturn $(`[${dialectPrefix}\\\\:${NAME}^=\"${fragmentName}\"]`, template) ||\n\t\t\t\t\t $(`[data-${dialectPrefix}-${NAME}^=\"${fragmentName}\"]`, template);\n\t}\n\tconsole.log('No template resolver configured');\n\treturn null;\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {NAME as FragmentAttributeProcessorName} from './FragmentAttributeProcessor.js';\nimport AttributeProcessor                       from '../../processors/AttributeProcessor.js';\nimport {getThymeleafAttributeValue}             from '../../utilities/Dom.js';\nimport {extractFragment}                        from '../../utilities/Fragments.js';\n\nimport {clearChildren} from '@ultraq/dom-utils';\n\nexport const NAME = 'insert';\n\n/**\n * JS equivalent of Thymeleaf's `th:insert` attribute processor, inserts the\n * referenced template fragment as a child of the current element.\n * \n * @author Emanuel Rabina\n */\nexport default class InsertAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `insert` name and supplied\n\t * prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:insert`/`data-th-insert` attribute,\n\t * replacing the current element's children with the DOM in the referenced\n\t * fragment.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} Whether or not the parent element needs to do a second\n\t *   pass as its children have been modified by this processor.\n\t */\n\tasync process(element, attribute, attributeValue, context) {\n\n\t\tsuper.process(element, attribute, attributeValue, context);\n\t\tclearChildren(element);\n\n\t\tlet fragmentInfo = context.expressionProcessor.process(attributeValue, context);\n\t\tif (fragmentInfo) {\n\t\t\tlet fragment = await extractFragment(this.prefix, fragmentInfo, context);\n\t\t\tif (fragment) {\n\t\t\t\tlet fragmentSignature = getThymeleafAttributeValue(fragment, this.prefix, FragmentAttributeProcessorName);\n\t\t\t\tlet {parameterNames} = context.fragmentSignatureProcessor.process(fragmentSignature, context);\n\t\t\t\tif (parameterNames) {\n\t\t\t\t\tlet {parameters} = fragmentInfo;\n\t\t\t\t\tlet localContext = {};\n\t\t\t\t\tparameterNames.forEach((parameterName, index) => {\n\t\t\t\t\t\tlocalContext[parameterName] = parameters[parameterName] || parameters[index] || null;\n\t\t\t\t\t});\n\t\t\t\t\tfragment.__thymeleafLocalVariables = localContext;\n\t\t\t\t}\n\t\t\t\telement.appendChild(fragment);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\n/**\n * Configurable attribute processor that sets or removes an attribute on an\n * element if the result of its expression is truthy or falsey respectively.\n * \n * @author Emanuel Rabina\n */\nexport default class RemovableAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set the name of the attribute this processor will operate on.\n\t * \n\t * @param {String} prefix\n\t * @param {String} name\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, name, isomorphic) {\n\n\t\tsuper(prefix, name, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains the configured attribute to be worked\n\t * on, setting it if the expression resolves to a truthy value, or removing it\n\t * if it resolves to a falsey value.\n\t * \n\t * @param {Element} element \n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tlet value = context.expressionProcessor.process(attributeValue, context);\n\t\tif (value) {\n\t\t\telement.setAttribute(this.name, value.toString());\n\t\t}\n\t\telse {\n\t\t\telement.removeAttribute(this.name);\n\t\t}\n\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n\nexport const REMOVABLE_ATTRIBUTE_NAMES = [\n\t'alt',\n\t'class'\n];\n","/* \n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'remove';\n\n/**\n * `th:remove`, used to remove the current element or select parts of it (and\n * its children).\n * \n * @author Emanuel Rabina\n */\nexport default class RemoveAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `remove` name and supplied\n\t * prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:remove`/`data-th-remove`\n\t * attribute, removing the current element or parts of it based on the\n\t * attribute value.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} Whether reprocessing behaviour needs to be applied, only\n\t *   when the current tag has been removed.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tsuper.process(element, attribute, attributeValue, context);\n\n\t\tswitch (attributeValue) {\n\t\t\tcase 'all':\n\t\t\t\telement.parentElement.removeChild(element);\n\t\t\t\treturn true;\n\t\t\tcase 'all-but-first':\n\t\t\t\twhile (element.lastElementChild !== element.firstElementChild) {\n\t\t\t\t\telement.removeChild(element.lastElementChild);\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t}\n\t}\n}\n","/*\n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {NAME as FragmentAttributeProcessorName} from './FragmentAttributeProcessor.js';\nimport AttributeProcessor                       from '../../processors/AttributeProcessor.js';\nimport {getThymeleafAttributeValue}             from '../../utilities/Dom.js';\nimport {extractFragment}                        from '../../utilities/Fragments.js';\n\nimport {clearChildren} from '@ultraq/dom-utils';\n\nexport const NAME = 'replace';\n\n/**\n * JS equivalent of Thymeleaf's `th:relace` attribute processor, replaces the\n * current element with the fragment referenced by the processor.\n * \n * @author Emanuel Rabina\n */\nexport default class ReplaceAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `replace` name and supplied\n\t * prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:replace`/`data-th-replace`\n\t * attribute, replacing the current element with the DOM in the referenced\n\t * fragment.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} Whether or not the parent element needs to do a second\n\t *   pass as its children have been modified by this processor.\n\t */\n\tasync process(element, attribute, attributeValue, context) {\n\n\t\tsuper.process(element, attribute, attributeValue, context);\n\t\tclearChildren(element);\n\n\t\tlet fragmentInfo = context.expressionProcessor.process(attributeValue, context);\n\t\tif (fragmentInfo) {\n\t\t\tlet fragment = await extractFragment(this.prefix, fragmentInfo, context);\n\t\t\tif (fragment) {\n\t\t\t\tlet fragmentSignature = getThymeleafAttributeValue(fragment, this.prefix, FragmentAttributeProcessorName);\n\t\t\t\tlet {parameterNames} = context.fragmentSignatureProcessor.process(fragmentSignature, context);\n\t\t\t\tif (parameterNames) {\n\t\t\t\t\tlet {parameters} = fragmentInfo;\n\t\t\t\t\tlet localContext = {};\n\t\t\t\t\tparameterNames.forEach((parameterName, index) => {\n\t\t\t\t\t\tlocalContext[parameterName] = parameters[parameterName] || parameters[index] || null;\n\t\t\t\t\t});\n\t\t\t\t\tfragment.__thymeleafLocalVariables = localContext;\n\t\t\t\t}\n\n\t\t\t\t// TODO: Can simplify this with insertAdjacent*(), but need to upgrade\n\t\t\t\t//       JSDOM first.\n\t\t\t\telement.parentElement.insertBefore(fragment, element);\n\t\t\t\telement.remove();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\telement.remove();\n\t\treturn false;\n\t}\n}\n","/* \n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Build a message string from a processed message expression.\n * \n * @param {Object} messageInfo\n * @param {Function} messageResolver\n * @return {Promise<String>}\n */\nexport async function buildMessage(messageInfo, messageResolver) {\n\tif (messageResolver) {\n\t\tlet {key, parameters} = messageInfo;\n\t\treturn await messageResolver(key, parameters) || '';\n\t}\n\tconsole.log('No message resolver configured');\n\treturn null;\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\nimport {buildMessage}     from '../../utilities/Messages.js';\n\nexport const NAME = 'text';\n\n/**\n * JS equivalent of Thymeleaf's `th:text` attribute processor, applies the\n * expression in the attribute value to the text content of the element being\n * processed, escaping any unsafe input.\n * \n * @author Emanuel Rabina\n */\nexport default class TextAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `text` name and supplied prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:text` or `data-th-text` attribute\n\t * on it, taking the text expression in the value and applying it to the text\n\t * content of the element.\n\t * \n\t * @param {Element} element \n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`.\n\t */\n\tasync process(element, attribute, attributeValue, context) {\n\n\t\t// TODO: Move message constructon to the expression language?  Need to make\n\t\t//       all the executions async!\n\t\tlet messageResult = context.expressionProcessor.process(attributeValue, context);\n\t\telement.textContent =\n\t\t\ttypeof messageResult === 'object' ? await buildMessage(messageResult, context.messageResolver) :\n\t\t\tmessageResult;\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nimport {clearChildren} from '@ultraq/dom-utils';\n\nexport const NAME = 'unless';\n\n/**\n * JS equivalent of Thymeleaf's `th:unless` attribute processor, excludes or\n * includes the current element and its children from rendering, depending on\n * the evaluation of the expression in the attribute value.\n * \n * @author Robbie Bardijn\n */\nexport default class UnlessAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `unless` name and supplied prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:unless` or `data-th-unless` attribute\n\t * on it, evaluating the expression for falsey/truthy, excluding/rendering the\n\t * element and its children based on the result.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `true` if the element was removed.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tlet expressionResult = context.expressionProcessor.process(attributeValue, context);\n\t\tif (expressionResult) {\n\t\t\tclearChildren(element);\n\t\t\t// TODO: element.remove()?\n\t\t\telement.parentNode.removeChild(element);\n\t\t\treturn true;\n\t\t}\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'utext';\n\n/**\n * JS equivalent of Thymeleaf's `th:utext` attribute processor, applies the\n * expression in the attribute value to the text content of the element being\n * processed.\n * \n * @author Emanuel Rabina\n */\nexport default class UTextAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `utext` name and supplied\n\t * prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:utext` or `data-th-utext`\n\t * attribute on it, taking the text expression in the value and applying it to\n\t * the text content of the element.\n\t *\n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\telement.innerHTML = context.expressionProcessor.process(attributeValue, context);\n\t\treturn super.process(element, attribute, attributeValue, context);\n\t}\n}\n","/* \n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\nexport const NAME = 'with';\n\n/**\n * `th:with`, used for creating scoped variables, useful for aliasing things.\n * \n * @author Emanuel Rabina\n */\nexport default class WithAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to use the `with` name and supplied\n\t * prefix.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper(prefix, NAME, isomorphic);\n\t}\n\n\t/**\n\t * Processes an element that contains a `th:with`/`data-th-with` attribute,\n\t * setting a variable scoped to the current element with the given name.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `true` as adding new local variables needs to re-run\n\t *   processing.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\tsuper.process(element, attribute, attributeValue, context);\n\n\t\tlet localVariables = {};\n\t\tlet aliases = context.expressionProcessor.process(attributeValue, context);\n\t\taliases.forEach(({name, value}) => {\n\t\t\tlocalVariables[name] = value;\n\t\t});\n\t\telement.__thymeleafLocalVariables = localVariables;\n\n\t\treturn true;\n\t}\n}\n","/* \n * Copyright 2020, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from '../../processors/AttributeProcessor.js';\n\n/**\n * `xmlns:th`, used for removing the Thymeleaf XML namespace often added to HTML\n * files to satisfy the XML validators that are used to edit them.\n * \n * @author Emanuel Rabina\n */\nexport default class XmlNsAttributeProcessor extends AttributeProcessor {\n\n\t/**\n\t * Constructor, set this processor to operate on the given XML namespace.\n\t * \n\t * @param {String} prefix\n\t * @param {Object} isomorphic\n\t */\n\tconstructor(prefix, isomorphic) {\n\n\t\tsuper('xmlns', prefix);\n\t\tthis.isomorphic = isomorphic;\n\t}\n\n\t/**\n\t * Removes the XML namespace from an element.\n\t * \n\t * @param {Element} element\n\t *   Element being processed.\n\t * @param {String} attribute\n\t *   The attribute that was encountered to invoke this processor.\n\t * @param {String} attributeValue\n\t *   The value given by the attribute.\n\t * @param {Object} context\n\t * @return {Boolean} `false`, as removing the XML namespace never requires\n\t *   repropcessing.\n\t */\n\tprocess(element, attribute, attributeValue, context) {\n\n\t\telement.removeAttribute(attribute);\n\t\tif (this.isomorphic) {\n\t\t\telement.removeAttribute(`xmlns:${this.isomorphic.prefix}`);\n\t\t}\n\t\treturn false;\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Common class for dialects.\n * \n * @author Emanuel Rabina\n */\nexport default class Dialect {\n\n\t/**\n\t * Constructor, sets this dialect's name and optional prefix.\n\t * \n\t * @param {String} name\n\t * @param {String} [prefix]\n\t */\n\tconstructor(name, prefix) {\n\n\t\tthis.name   = name;\n\t\tthis.prefix = prefix;\n\t}\n\n\t/**\n\t * Return an object whose keys are the expression object names, the values the\n\t * expression object available properties and methods.\n\t * \n\t * @return {Object}\n\t */\n\tget expressionObjects() {\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Return an array of processors.\n\t * \n\t * @return {Array}\n\t */\n\tget processors() {\n\n\t\treturn null;\n\t}\n}\n","/*\n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttrAttributeProcessor        from './processors/AttrAttributeProcessor.js';\nimport BlockElementProcessor         from './processors/BlockElementProcessor.js';\nimport CheckedAttributeProcessor     from './processors/CheckedAttributeProcessor.js';\nimport ClassAppendAttributeProcessor from './processors/ClassAppendAttributeProcessor.js';\nimport EachAttributeProcessor        from './processors/EachAttributeProcessor.js';\nimport EmptyableAttributeProcessor, {\n\tEMPTYABLE_ATTRIBUTE_NAMES\n}                                    from './processors/EmptyableAttributeProcessor.js';\nimport FragmentAttributeProcessor    from './processors/FragmentAttributeProcessor.js';\nimport IfAttributeProcessor          from './processors/IfAttributeProcessor.js';\nimport InsertAttributeProcessor      from './processors/InsertAttributeProcessor.js';\nimport RemovableAttributeProcessor, {\n\tREMOVABLE_ATTRIBUTE_NAMES\n}                                    from './processors/RemovableAttributeProcessor.js';\nimport RemoveAttributeProcessor      from './processors/RemoveAttributeProcessor.js';\nimport ReplaceAttributeProcessor     from './processors/ReplaceAttributeProcessor.js';\nimport TextAttributeProcessor        from './processors/TextAttributeProcessor.js';\nimport UnlessAttributeProcessor      from './processors/UnlessAttributeProcessor.js';\nimport UTextAttributeProcessor       from './processors/UTextAttributeProcessor.js';\nimport WithAttributeProcessor        from './processors/WithAttributeProcessor.js';\nimport XmlNsAttributeProcessor       from './processors/XmlNsAttributeProcessor.js';\nimport Dialect                       from '../dialects/Dialect.js';\n\nexport const NAME = 'Standard';\nexport const DEFAULT_PREFIX = 'thjs';\n\n/**\n * The out-of-the-box dialect for Thymeleaf, the \"Standard Dialect\".\n * \n * @author Emanuel Rabina\n */\nexport default class StandardDialect extends Dialect {\n\n\t/**\n\t * Create an instance of this dialect with the name \"Standard\" and given\n\t * prefix.\n\t * \n\t * @param {String} [prefix='thjs']\n\t * @param {Object} [isomorphic]\n\t */\n\tconstructor(prefix = DEFAULT_PREFIX, isomorphic) {\n\n\t\tsuper(NAME, prefix);\n\t\tthis.isomorphic = isomorphic;\n\t}\n\n\t/**\n\t * Returns the supported standard processors.\n\t * \n\t * @return {Array} A list of the processors included in this dialect.\n\t */\n\tget processors() {\n\n\t\t// TODO: This is a very basic way of imposing the order of attribute\n\t\t//       processors.  It's currently ordered in the same way as OG\n\t\t//       Thymeleaf.  Figure out a 'proper' way to do the ordering.\n\n\t\t// Order taken from https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#attribute-precedence\n\t\tlet {prefix, isomorphic} = this;\n\t\treturn [\n\t\t\t// Fragment inclusion\n\t\t\tnew InsertAttributeProcessor(prefix, isomorphic),\n\t\t\tnew ReplaceAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// Fragment iteration\n\t\t\tnew EachAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// Conditional evaluation\n\t\t\tnew IfAttributeProcessor(prefix, isomorphic),\n\t\t\tnew UnlessAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// Local variable definition\n\t\t\tnew WithAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// General attribute modification\n\t\t\tnew AttrAttributeProcessor(prefix, isomorphic),\n\t\t\tnew ClassAppendAttributeProcessor(prefix, isomorphic),\n\t\t\t...EMPTYABLE_ATTRIBUTE_NAMES.map(attributeName => {\n\t\t\t\treturn new EmptyableAttributeProcessor(prefix, attributeName, isomorphic);\n\t\t\t}),\n\t\t\t...REMOVABLE_ATTRIBUTE_NAMES.map(attributeName => {\n\t\t\t\treturn new RemovableAttributeProcessor(prefix, attributeName, isomorphic);\n\t\t\t}),\n\n\t\t\t// Specific attribute modification\n\t\t\tnew CheckedAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// Text\n\t\t\tnew TextAttributeProcessor(prefix, isomorphic),\n\t\t\tnew UTextAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// Fragment specification\n\t\t\tnew FragmentAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// Fragment removal\n\t\t\tnew RemoveAttributeProcessor(prefix, isomorphic),\n\n\t\t\t// Element processors\n\t\t\tnew BlockElementProcessor(prefix),\n\n\t\t\t// Misc\n\t\t\tnew XmlNsAttributeProcessor(prefix, isomorphic)\n\t\t];\n\t}\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport StandardDialect from './standard/StandardDialect.js';\n\n/**\n * Configuration object for the template engine.\n * \n * @typedef {Object} Configuration\n * @property {Array<Dialect>} dialects\n *   A list of dialects to include with this instance of the template engine.\n * @property {Object} [isomorphic]\n *   An object which configures the isomorphic capabilities of the template\n *   engine.\n * @property {Function} messageResolver\n *   A function for building a message string from some external source, given a\n *   message key and optional parameters for that particular message.\n * @property {Function} templateResolver\n *   A function for returning the text of templates named by fragment\n *   expressions in templates.  Is given only 1 argument, the template name from\n *   a fragment expression, and should return a Promise of the template text.\n */\n\n/**\n * Default configuration for the template engine, configures the standard\n * dialect with no options (uses `thjs` as the prefix).\n * \n * @type {Configuration}\n */\nexport const DEFAULT_CONFIGURATION = {\n\tdialects: [\n\t\tnew StandardDialect()\n\t]\n};\n\n/**\n * Standard configuration, configures the standard dialect with the `th` prefix\n * and enables isomorphic mode which enables the ability to use much of the same\n * processors across original Thymeleaf and ThymeleafJS.\n * \n * @type {Configuration}\n */\nexport const STANDARD_CONFIGURATION = {\n\t...DEFAULT_CONFIGURATION,\n\tdialects: [\n\t\tnew StandardDialect('th', {\n\t\t\tprefix: 'thjs'\n\t\t})\n\t]\n};\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport AttributeProcessor from './AttributeProcessor.js';\nimport ElementProcessor   from './ElementProcessor.js';\n\n/**\n * Class for determining if an element contains a processor on it.\n * \n * @author Emanuel Rabina\n */\nexport default class Matcher {\n\n\t/**\n\t * Return the matching attribute or element that a processor can work over.\n\t * \n\t * @param {Element} element\n\t * @param {AttributeProcessor} processor\n\t * @return {String}\n\t *   A match result containing what was matched (either an attribute or an\n\t *   element, relevant to the processor being tested), or `null` if nothing\n\t *   was matched.\n\t */\n\tmatches(element, processor) {\n\n\t\tlet {isomorphic, name, prefix} = processor;\n\n\t\t// Attribute processor matching, can be of the name prefix:name or data-prefix-name\n\t\tif (processor instanceof AttributeProcessor) {\n\t\t\tlet prefixes = [prefix];\n\t\t\tif (isomorphic) {\n\t\t\t\tprefixes.unshift(isomorphic.prefix);\n\t\t\t}\n\t\t\tfor (let prefix of prefixes) {\n\t\t\t\tlet attribute;\n\t\t\t\tattribute = `${prefix}:${name}`;\n\t\t\t\tif (element.hasAttribute(attribute)) {\n\t\t\t\t\treturn attribute;\n\t\t\t\t}\n\t\t\t\tattribute = `data-${prefix}-${name}`;\n\t\t\t\tif (element.hasAttribute(attribute)) {\n\t\t\t\t\treturn attribute;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Element processor, can only be of the name prefix:name\n\t\telse if (processor instanceof ElementProcessor) {\n\t\t\tlet elementName = `${processor.prefix}:${name}`;\n\t\t\tif (element.tagName === elementName.toUpperCase()) {\n\t\t\t\treturn elementName;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Wrapper around the string being parsed, with a position that keeps track of\n * what part of the imput is currently being read/tested.\n * \n * @author Emanuel Rabina\n */\nexport default class InputBuffer {\n\n\t/**\n\t * @private\n\t * @type {Number}\n\t */\n\tposition = 0;\n\n\t/**\n\t * @private\n\t * @type {Array<Number>}\n\t */\n\tpositionStack = [];\n\n\t/**\n\t * @param {String} input\n\t */\n\tconstructor(input) {\n\n\t\tthis.input = input;\n\t}\n\n\t/**\n\t * Clear the previously {@link #mark}ed position.\n\t */\n\tclear() {\n\n\t\tlet lastPosition = this.positionStack.pop();\n\t\tif (lastPosition === undefined) {\n\t\t\tthrow new Error('Called clear() but no matching mark()');\n\t\t}\n\t}\n\n\t/**\n\t * Returns whether or not the current position is at the end of the input,\n\t * meaning we've exhausted the entire input string.\n\t * \n\t * @return {Boolean}\n\t */\n\texhausted() {\n\n\t\treturn this.position === this.input.length;\n\t}\n\n\t/**\n\t * Sets a mark at the current position so that it can be returned to by a\n\t * matching {@link #reset} call.\n\t */\n\tmark() {\n\n\t\tthis.positionStack.push(this.position);\n\t}\n\n\t/**\n\t * Convenience method for surrounding a function with a call to {@link #mark},\n\t * then {@link #clear} if the result of the function is non-null, or\n\t * {@link #reset} if `null`.\n\t * \n\t * @template T\n\t * @param {Function<T>} func\n\t * @return {T}\n\t */\n\tmarkAndClearOrReset(func) {\n\n\t\tthis.mark();\n\t\tlet result = func();\n\t\tif (result !== null) {\n\t\t\tthis.clear();\n\t\t\treturn result;\n\t\t}\n\t\tthis.reset();\n\t\treturn null;\n\t}\n\n\t/**\n\t * Reads as many characters from the current position as satisfies the given\n\t * pattern, returning the read characters and advancing the mark by as many\n\t * characters.\n\t * \n\t * @param {RegExp} pattern\n\t * @return {Array} The array of matched strings, or `null` if the pattern\n\t *   didn't match.\n\t */\n\tread(pattern) {\n\n\t\tlet remaining = this.input.substring(this.position);\n\t\tlet leadingWhitespace = remaining.match(/^\\s+/);\n\t\tif (leadingWhitespace) {\n\t\t\tleadingWhitespace = leadingWhitespace[0];\n\t\t\tremaining = remaining.substring(leadingWhitespace.length);\n\t\t}\n\t\tlet result = new RegExp(pattern.source).exec(remaining);\n\t\tif (result) {\n\t\t\tlet [value] = result;\n\t\t\tif (remaining.startsWith(value)) {\n\t\t\t\tthis.position += (value.length + (leadingWhitespace ? leadingWhitespace.length : 0));\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Revert to the last @{link #mark}ed position.\n\t */\n\treset() {\n\n\t\tlet newPosition = this.positionStack.pop();\n\t\tif (newPosition === undefined) {\n\t\t\tthrow new Error('Called reset() but no matching mark()');\n\t\t}\n\t\tthis.position = newPosition;\n\t}\n}\n","/*\n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport InputBuffer from './InputBuffer';\n\n/**\n * Any one of the objects that can be matched:\n *  - an expression function\n *  - a string that references another rule\n *  - a regular expression\n * \n * @typedef {String|RegExp|Function} Matchable\n */\n\n/**\n * A recursive descent parser for any parsing expression grammar defined by the\n * constructs in this module.\n * \n * TODO: Own module?\n * \n * @author Emanuel Rabina\n */\nexport default class Parser {\n\n\texpressionStack = [];\n\n\t/**\n\t * @param {Grammar} grammar\n\t */\n\tconstructor(grammar) {\n\n\t\tthis.grammar = grammar;\n\t}\n\n\t/**\n\t * Parse a string, attempting to build the parse tree defined by the rules in\n\t * the configured grammar.  Parsing is considered successful when there are no\n\t * more non-terminating symbols in the grammar and all of the input has been\n\t * read.\n\t * \n\t * @param {String} input\n\t * @return {Object} The parse tree if the input could be parsed, `null`\n\t *   otherwise.\n\t */\n\tparse(input) {\n\n\t\tlet inputBuffer = new InputBuffer(input);\n\t\tlet matchResult = this.grammar.accept(inputBuffer, this);\n\t\tif (matchResult === null || !inputBuffer.exhausted()) {\n\t\t\tlet errorMessage = `Failed to parse \"${input}\"`;\n\n\t\t\t// Don't bring down the thread if we can't parse\n\t\t\tif (process.env.NODE_ENV === 'production') {\n\t\t\t\tconsole.error(errorMessage);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthrow new Error(errorMessage);\n\t\t\t}\n\t\t}\n\t\treturn matchResult;\n\t}\n\n\t/**\n\t * Parse the input against the given expression.  An expression can either be\n\t * a reference to another rule in the current grammar, or a regular expression\n\t * that consumes input.\n\t * \n\t * @param {InputBuffer} input\n\t * @param {Matchable} expression\n\t * @return {Object}\n\t */\n\tparseWithExpression(input, expression) {\n\n\t\t// Name of another rule in the grammar\n\t\tif (typeof expression === 'string') {\n\t\t\tlet rule = this.grammar.findRuleByName(expression);\n\t\t\treturn rule ? rule.accept(input, this) : null;\n\t\t}\n\n\t\t// A regular expression that must be matched\n\t\telse if (expression instanceof RegExp) {\n\t\t\tlet result = input.read(expression);\n\t\t\tif (result) {\n\t\t\t\treturn result[0];\n\t\t\t}\n\t\t}\n\n\t\t// An expression function to be executed\n\t\telse if (typeof expression === 'function') {\n\t\t\treturn expression(input, this);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Surrounds a function that evaluates an expression with tracking it against\n\t * the current stack.  Useful for knowing how the current expression was\n\t * arrived at through the grammar's rules.\n\t * \n\t * @template T\n\t * @param {InputBuffer} input\n\t * @param {Matchable} expression\n\t * @param {String} name\n\t * @param {Function<T>} func\n\t * @return {T}\n\t */\n\ttrackExpression(input, expression, name, func) {\n\n\t\tlet stackSize = this.expressionStack.push({\n\t\t\tname,\n\t\t\texpression: typeof expression !== 'function' ? expression.toString() : null,\n\t\t\tinput: input.input.substring(input.position)\n\t\t});\n\t\tlet result = func();\n\t\tif (result !== null) {\n\t\t\treturn result;\n\t\t}\n\t\tthis.expressionStack.splice(stackSize - 1);\n\t\treturn null;\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Parser from '../../parser/Parser.js';\n\n/**\n * Parses and executes Thymeleaf expressions.\n * \n * TODO: Create a shared instance of this for a processing context so that it\n *       doesn't need to be recreated over and over.\n * \n * @author Emanuel Rabina\n */\nexport default class ExpressionProcessor {\n\n\t/**\n\t * Constructor, create a new processor that can parse/execute a string in the\n\t * given grammar.\n\t * \n\t * @param {Grammar} grammar\n\t */\n\tconstructor(grammar) {\n\n\t\tthis.parser = new Parser(grammar);\n\t}\n\n\t/**\n\t * Parse and execute the given input as a Thymeleaf expression.\n\t * \n\t * @param {String} input\n\t * @param {Object} [context={}]\n\t * @return {*}\n\t */\n\tprocess(input, context = {}) {\n\n\t\tlet expression = this.parser.parse(input);\n\t\treturn expression?.({\n\t\t\t...context,\n\t\t\texpression: input\n\t\t});\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A special kind of expression that requires the referenced rule consume all\n * available input.\n * \n * @param {String} ruleName\n * @return {Matchable}\n */\nexport const AllInput = ruleName => (input, parser) => {\n\tlet matchResult = parser.parseWithExpression(input, ruleName);\n\treturn matchResult !== null && input.exhausted() ? matchResult : null;\n};\n","/*\n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Default processor which returns the result as is.\n * \n * @template T\n * @param {T} result\n * @return {T}\n */\nconst defaultMatchProcessor = result => result;\n\n/**\n * A rule describes a string in the language.\n * \n * @author Emanuel Rabina\n */\nexport default class Rule {\n\n\t/**\n\t * @param {String} name\n\t * @param {Object} expression\n\t * @param {Function} [matchProcessor=defaultMatchProcessor]\n\t */\n\tconstructor(name, expression, matchProcessor = defaultMatchProcessor) {\n\n\t\tthis.name           = name;\n\t\tthis.expression     = expression;\n\t\tthis.matchProcessor = matchProcessor;\n\t}\n\n\t/**\n\t * Given an input string and a parser, return whether or not the input is\n\t * accepted by this rule.\n\t * \n\t * @param {InputBuffer} input\n\t * @param {Parser} parser\n\t * @return {Object} If the input is accepted, this will be the non-null result\n\t *   of matching against the rule.\n\t */\n\taccept(input, parser) {\n\n\t\tlet {expression, name} = this;\n\t\treturn parser.trackExpression(input, expression, name, () => {\n\t\t\tlet matchResult = parser.parseWithExpression(input, expression);\n\t\t\treturn matchResult !== null ? this.matchProcessor(matchResult) : null;\n\t\t});\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Rule from '../../parser/Rule.js';\n\n/**\n * A custom rule where the default match processor returns a function to execute\n * against the current context to discover the matched value.\n */\nexport default class ThymeleafRule extends Rule {\n\n\t/**\n\t * @param {String} name\n\t * @param {Object} expression\n\t * @param {Function} [matchProcessor]\n\t */\n\tconstructor(name, expression, matchProcessor) {\n\n\t\tconst contextSensitiveMatchProcessor = result => (...args) => {\n\t\t\t// console.log(`Processing rule: ${name}`);\n\t\t\treturn typeof result === 'function' ? result.apply(null, args) : result;\n\t\t};\n\t\tsuper(name, expression, matchProcessor || contextSensitiveMatchProcessor);\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A collection of Rules that describes a language.\n * \n * @author Emanuel Rabina\n */\nexport default class Grammar {\n\n\t/**\n\t * @param {String} name\n\t * @param {Rule} startingRule\n\t * @param {...Rule} additionalRules\n\t */\n\tconstructor(name, startingRule, ...additionalRules) {\n\n\t\tthis.name = name;\n\t\tthis.rules = [].concat(startingRule, additionalRules);\n\t}\n\n\t/**\n\t * Given an input string and a parser, return whether or not the input is\n\t * accepted by this grammar.\n\t * \n\t * @param {InputBuffer} input\n\t * @param {Parser} parser\n\t * @return {Object} If the input is accepted, this will be the non-null result\n\t *   of matching against the rules of this grammar.\n\t */\n\taccept(input, parser) {\n\n\t\treturn this.startingRule.accept(input, parser);\n\t}\n\n\t/**\n\t * Return the rule that has the given name.\n\t * \n\t * @param {String} name\n\t * @return {Rule}\n\t */\n\tfindRuleByName(name) {\n\n\t\tlet rule = this.rules.find(rule => rule.name === name);\n\t\tif (!rule) {\n\t\t\tthrow new Error(`Failed to find a rule named \"${name}\" in the grammar`);\n\t\t}\n\t\treturn rule;\n\t}\n\n\t/**\n\t * Returns the grammar's starting rule.\n\t * \n\t * @return {Rule}\n\t */\n\tget startingRule() {\n\n\t\treturn this.rules[0];\n\t}\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns an expression function where the underlying expression doesn't need\n * to be matched.  Thus, optional expressions \"always\" match.\n * \n * @param {Matchable} expression\n * @return {Matchable}\n */\nexport const Optional = expression => (input, parser) => {\n\treturn input.markAndClearOrReset(() => {\n\t\tlet result = parser.parseWithExpression(input, expression);\n\t\treturn result !== null ? result : '';\n\t});\n};\n\n/**\n * Returns an expression function where the expression must be matched against\n * at least once to be considered a match.\n * \n * @param {Matchable} expression\n * @return {Matchable}\n */\nexport const OneOrMore = (expression) => (input, parser) => {\n\treturn input.markAndClearOrReset(() => {\n\t\tlet results = [];\n\t\twhile (true) {\n\t\t\tlet result = input.markAndClearOrReset(() => {\n\t\t\t\treturn parser.parseWithExpression(input, expression);\n\t\t\t});\n\t\t\tif (result) {\n\t\t\t\tresults.push(result);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn results.length > 0 ? results : null;\n\t});\n};\n\n/**\n * Returns an expression function where only one of the underlying expressions\n * must be matched in order to consider the expression a match.\n * \n * @param {...Matchable} expressions\n * @return {Matchable}\n */\nexport const OrderedChoice = (...expressions) => (input, parser) => {\n\treturn input.markAndClearOrReset(() => {\n\t\tfor (let expression of expressions) {\n\t\t\tlet result = input.markAndClearOrReset(() => {\n\t\t\t\treturn parser.parseWithExpression(input, expression);\n\t\t\t});\n\t\t\tif (result !== null) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t});\n};\n\n/**\n * Returns an expression whose underlying expressions must be matched in order\n * to consider the entire expression a match.\n * \n * @param {...Matchable} expressions\n * @return {Matchable}\n */\nexport const Sequence = (...expressions) => (input, parser) => {\n\treturn input.markAndClearOrReset(() => {\n\t\tlet results = [];\n\t\tfor (let expression of expressions) {\n\t\t\tlet result = input.markAndClearOrReset(() => {\n\t\t\t\treturn parser.parseWithExpression(input, expression);\n\t\t\t});\n\t\t\tif (result === null) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tresults.push(result);\n\t\t}\n\t\treturn results;\n\t});\n};\n\n/**\n * Returns an expression function where the expression can be matched a repeated\n * number of times or none at all to be considered a match.\n * \n * @param {Matchable} expression\n * @return {Matchable}\n */\nexport const ZeroOrMore = (expression) => (input, parser) => {\n\treturn input.markAndClearOrReset(() => {\n\t\tlet results = [];\n\t\twhile (true) {\n\t\t\tlet result = input.markAndClearOrReset(() => {\n\t\t\t\treturn parser.parseWithExpression(input, expression);\n\t\t\t});\n\t\t\tif (result) {\n\t\t\t\tresults.push(result);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn results;\n\t});\n};\n","/* \n * Copyright 2019, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AllInput}                       from './AllInput.js';\nimport ThymeleafRule                    from './ThymeleafRule.js';\nimport Grammar                          from '../../parser/Grammar.js';\nimport {Optional, Sequence, ZeroOrMore} from '../../parser/Operators.js';\n\nimport {flatten} from '@ultraq/array-utils';\n\n/**\n * Grammar for Thymeleaf fragment signatures.  This is separate from the\n * expression language as these are not expressions, but rather marker syntaxes.\n * \n * @author Emanuel Rabina\n */\nexport default new Grammar('Thymeleaf fragment signature',\n\n\tnew ThymeleafRule('ThymeleafFragmentSignatureRule',\n\t\tAllInput('FragmentSignature')\n\t),\n\n\t/**\n\t * The target end of a fragment expression, contains the fragment name and\n\t * optional parameter names.\n\t */\n\tnew ThymeleafRule('FragmentSignature',\n\t\tSequence('FragmentName', Optional('FragmentParameters')),\n\t\t([fragmentName, parameterNames]) => context => {\n\t\t\treturn {\n\t\t\t\tfragmentName: fragmentName(context),\n\t\t\t\tparameterNames: parameterNames ? parameterNames(context) : null\n\t\t\t};\n\t\t}\n\t),\n\tnew ThymeleafRule('FragmentName', /[\\w-._]+/),\n\tnew ThymeleafRule('FragmentParameters',\n\t\tSequence(/\\(/, ZeroOrMore('FragmentParameterNames'), /\\)/),\n\t\t([, [parameterNames]]) => context => {\n\t\t\treturn parameterNames(context);\n\t\t}\n\t),\n\tnew ThymeleafRule('FragmentParameterNames',\n\t\tSequence('Identifier', ZeroOrMore(Sequence(/,/, 'Identifier'))),\n\t\t(namesAndSeparators) => context => {\n\t\t\treturn namesAndSeparators ?\n\t\t\t\tflatten(namesAndSeparators)\n\t\t\t\t\t.filter(item => item !== ',')\n\t\t\t\t\t.map(name => name(context)) :\n\t\t\t\t[];\n\t\t}\n\t),\n\n\n\t// Common language basics\n\t// ======================\n\n\tnew ThymeleafRule('Identifier', /[#a-zA-Z_][\\w]*/)\n);\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport InputBuffer from './InputBuffer';\n\n/**\n * A special kind of expression that understands matched portions of regular\n * expressions to run processing over, which may lead to additional parsing\n * expressions.\n * \n * This expression should be used sparingly as the regexes within need to take\n * care of whitespace between tokens themselves, which can be annoying.\n * \n * @param {RegExp} expression\n * @param {Array<Matchable>} matchers\n * @return {Matchable}\n */\nexport const RegularExpression = (expression, matchers) => (input, parser) => {\n\treturn input.markAndClearOrReset(() => {\n\t\tlet result = input.read(expression);\n\t\tif (result) {\n\t\t\tlet parseResults = [result[0]];\n\t\t\tfor (let i = 1; i < result.length; i++) {\n\t\t\t\tlet match = result[i];\n\t\t\t\tif (match !== undefined) {\n\t\t\t\t\tlet parseResult = parser.parseWithExpression(new InputBuffer(match), matchers[i - 1]);\n\t\t\t\t\tif (parseResult === null) {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t\tparseResults.push(parseResult);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn parseResults;\n\t\t}\n\t\treturn null;\n\t});\n};\n","/**\n *\n * @param {Object|Array} obj\n * @param {string} path\n * @return {*}\n */\nexport function getByPath(obj, path) {\n\tconst paths = getPathArray(path);\n\tlet requestedObject = Array.isArray(obj) ? [...obj] : {...obj};\n\n\tfor (let i = 0; i < paths.length; i++) {\n\t\ttry {\n\t\t\tif (requestedObject[paths[i]] === undefined) {\n\t\t\t\trequestedObject = null;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\trequestedObject = requestedObject[paths[i]];\n\t\t}\n\t\tcatch (e) {\n\t\t\trequestedObject = null;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn requestedObject;\n}\n\n/**\n * Helper function to convert array like path string into array\n *\n * @param {string} path\n * @return {Array<string>}\n */\nexport function getPathArray(path) {\n\treturn path.split('.').reduce((acc, el) => {\n\t\treturn acc.concat(el.replace(/[\"']/g, '')\n\t\t\t.split('[')\n\t\t\t.filter(i => i !== '')\n\t\t\t.map(i => i.replace(']', '')));\n\t}, []);\n}\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AllInput}          from './AllInput.js';\nimport ExpressionProcessor from './ExpressionProcessor.js';\nimport ThymeleafRule       from './ThymeleafRule.js';\nimport Grammar             from '../../parser/Grammar.js';\nimport {\n\tOptional,\n\tOneOrMore,\n\tOrderedChoice,\n\tSequence,\n\tZeroOrMore\n}                          from '../../parser/Operators.js';\nimport {RegularExpression} from '../../parser/RegularExpression.js';\nimport { getByPath }       from '../../utilities/getByPath';\n\nimport {flatten, remove} from '@ultraq/array-utils';\n\n// For helping identify rules that return objects\nconst METADATA_FRAGMENT  = 'fragment';\nconst METADATA_ITERATION = 'iteration';\nconst METADATA_MESSAGE   = 'message';\n\n/**\n * Grammar for the Thymeleaf expression language.  Describes the language and\n * how to parse it.\n * \n * @author Emanuel Rabina\n */\nconst ThymeleafExpressionLanguage = new Grammar('Thymeleaf Expression Language',\n\n\t// Ordered as at https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#standard-expression-syntax\n\tnew ThymeleafRule('ThymeleafExpression',\n\t\tOrderedChoice(\n\t\t\tAllInput('VariableExpression'),\n\t\t\tAllInput('MessageExpression'),\n\t\t\tAllInput('LinkExpression'),\n\t\t\tAllInput('FragmentExpression'),\n\t\t\tAllInput('Iteration'),\n\t\t\tAllInput('StringConcatenation'),\n\t\t\tAllInput('ScopedVariables'),\n\t\t\tAllInput('Literal'),\n\t\t\tAllInput('LogicalExpression'),\n\t\t\tAllInput('IfThenCondition'),\n\t\t\tAllInput('IfThenElseCondition'),\n\t\t\tAllInput('TokenLiteral'),\n\t\t\tAllInput('Nothing')\n\t\t)\n\t),\n\n\n\t// Simple expressions\n\t// ==================\n\n\t/**\n\t * Variable expressions, `${variable}`.  Represents a value to be retrieved\n\t * from the current context.  Also is an entry into the underlying expression\n\t * language, so this part often extends to do what OGNL (and thus SpEL) can\n\t * do.\n\t */\n\n\tnew ThymeleafRule('VariableExpression',\n\t\tSequence(/\\${/, 'Chain', /\\}/),\n\t\t([, chain]) => context => {\n\t\t\tlet result = chain(context);\n\t\t\treturn result !== null && result !== undefined ? result : '';\n\t\t}\n\t),\n\tnew ThymeleafRule('Chain',\n\t\tSequence(Optional('Negation'), 'ChainLink', ZeroOrMore(Sequence(/\\./, 'ChainLink'))),\n\t\t([negation, ...chain]) => context => {\n\t\t\tlet result = flatten(chain).filter(link => link !== '.').reduce((linkContext, nextLink) => {\n\t\t\t\tif (linkContext === null || linkContext === undefined) {\n\t\t\t\t\treturn linkContext;\n\t\t\t\t}\n\t\t\t\treturn nextLink(linkContext, context);\n\t\t\t}, context);\n\t\t\t// TODO: Need a better way of applying negation - this fails when I\n\t\t\t//       introduce the 'not' keyword\n\t\t\treturn typeof negation === 'function' ? !result : result;\n\t\t}\n\t),\n\tnew ThymeleafRule('ChainLink',\n\t\tOrderedChoice('MethodCall', 'ArrayIndex', 'PropertyName', 'Literal')\n\t),\n\n\t/**\n\t * Message expressions, `#{messageKey(parameters)}`.  Used for referencing\n\t * text from a resource file, often for localization purposes.\n\t */\n\tnew ThymeleafRule('MessageExpression',\n\t\tSequence(/#{/, 'MessageKey', Optional(Sequence(/\\(/, Sequence('Expression', ZeroOrMore(Sequence(/,/, 'Expression'))), /\\)/)), /}/),\n\t\t([, messageKey, [, messageParameters]]) => context => {\n\t\t\treturn {\n\t\t\t\ttype: METADATA_MESSAGE,\n\t\t\t\tkey: messageKey(context),\n\t\t\t\tparameters: messageParameters ?\n\t\t\t\t\tflatten(messageParameters)\n\t\t\t\t\t\t.filter(messageParameter => typeof messageParameter === 'function')\n\t\t\t\t\t\t.map(messageParameter => messageParameter(context)) :\n\t\t\t\t\tnull\n\t\t\t};\n\t\t}\n\t),\n\tnew ThymeleafRule('MessageKey', /[\\w.-]+/),\n\n\t/**\n\t * Link expressions, `@{url(parameters)}`.  Used for generating URLs out of\n\t * context parameters.\n\t * \n\t * TODO: Change this to use the other expression types so I can remove this\n\t *       bespoke operator.\n\t */\n\tnew ThymeleafRule('LinkExpression',\n\t\tRegularExpression(/^@\\{(.+?)(\\(.+\\))?\\}$/, ['Url', 'UrlParameters']),\n\t\t([, urlFunc, parameters]) => context => {\n\n\t\t\tlet url = urlFunc(context);\n\t\t\tif (parameters) {\n\n\t\t\t\t// TODO: Push this parsing of the parameters list back into the grammar\n\t\t\t\tlet expressionProcessor = new ExpressionProcessor(ThymeleafExpressionLanguage);\n\t\t\t\tlet paramsList = parameters(context).slice(1, -1).split(',').map(param => {\n\t\t\t\t\tlet [lhs, rhs] = param.split('=');\n\t\t\t\t\treturn [lhs, expressionProcessor.process(rhs, context)];\n\t\t\t\t});\n\n\t\t\t\t// Fill out any placeholders in the URL from the parameters\n\t\t\t\twhile (true) { // eslint-disable-line\n\t\t\t\t\tlet urlTemplate = /(.*?)\\{(.+?)\\}(.*)/.exec(url);\n\t\t\t\t\tif (urlTemplate) {\n\t\t\t\t\t\tlet [, head, placeholder, tail] = urlTemplate;\n\t\t\t\t\t\tlet paramEntry = remove(paramsList, ([lhs]) => lhs === placeholder);\n\t\t\t\t\t\tif (paramEntry) {\n\t\t\t\t\t\t\turl = `${head}${paramEntry[1]}${tail}`;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Remaining parameters become search query parameters\n\t\t\t\tif (paramsList.length) {\n\t\t\t\t\turl += `?${paramsList.map(([key, value]) => `${key}=${value}`).join('&')}`;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn url;\n\t\t}\n\t),\n\tnew ThymeleafRule('Url', /.+/),\n\tnew ThymeleafRule('UrlParameters', /\\((.+)\\)/),\n\n\t/**\n\t * Fragment expressions, `~{template :: fragment(parameters)}`.  A locator for\n\t * a piece of HTML in the same or another template.\n\t */\n\tnew ThymeleafRule('FragmentExpression',\n\t\tSequence(/~{/, 'TemplateName', /::/, 'FragmentName', Optional('FragmentParametersSection'), /}/),\n\t\t([, templateName, , fragmentName, parameters]) => context => {\n\n\t\t\t// TODO: Should executing a fragment expression locate and return the\n\t\t\t//       fragment?  If so, then it'll make expression execution\n\t\t\t//       asynchronous!\n\t\t\treturn {\n\t\t\t\ttype: METADATA_FRAGMENT,\n\t\t\t\ttemplateName: templateName(context),\n\t\t\t\tfragmentName: fragmentName(context),\n\t\t\t\tparameters: parameters ? parameters(context) : null\n\t\t\t};\n\t\t}\n\t),\n\tnew ThymeleafRule('TemplateName',\n\t\tOrderedChoice(\n\t\t\t/[\\w-._/]+/,\n\t\t\t'VariableExpression'\n\t\t)\n\t),\n\tnew ThymeleafRule('FragmentName', /[\\w-._]+/),\n\tnew ThymeleafRule('FragmentParametersSection',\n\t\tSequence(/\\(/, Optional('FragmentParameters'), /\\)/),\n\t\t([, parameters]) => context => {\n\t\t\treturn parameters(context);\n\t\t}\n\t),\n\tnew ThymeleafRule('FragmentParameters',\n\t\tSequence('Expression', ZeroOrMore(Sequence(/,/, 'Expression'))),\n\t\t(expressionsAndSeparators) => context => {\n\t\t\treturn expressionsAndSeparators ?\n\t\t\t\tflatten(expressionsAndSeparators)\n\t\t\t\t\t.filter(item => item !== ',')\n\t\t\t\t\t.map(expressions => expressions(context)) :\n\t\t\t\t[];\n\t\t}\n\t),\n\n\n\t// Complex expressions\n\t// ===================\n\n\t/**\n\t * Iteration, `localVar : ${collection}`.  The name of the variable for each\n\t * loop, followed by the collection being iterated over.\n\t */\n\tnew ThymeleafRule('Iteration',\n\t\tSequence('Identifier', Optional(Sequence(/,/, 'Identifier')), /:/, 'VariableExpression'),\n\t\t([localValueName, [, iterationStatusVariable], , collectionExpressionAction]) => context => ({\n\t\t\ttype: METADATA_ITERATION,\n\t\t\tlocalValueName: localValueName(context),\n\t\t\titerable: collectionExpressionAction(context),\n\t\t\titerationStatusVariable: iterationStatusVariable ? iterationStatusVariable(context) : null\n\t\t})\n\t),\n\n\t/**\n\t * Scoped variable aliases, `key=${expression},...`, describes one or more\n\t * names for scoped variables with the expressions that can be their values.\n\t */\n\tnew ThymeleafRule('ScopedVariables',\n\t\tSequence('ScopedVariable', ZeroOrMore(Sequence(/,/, 'ScopedVariable'))),\n\t\t(aliases) => context => {\n\t\t\treturn flatten(aliases).map(alias => alias(context));\n\t\t}\n\t),\n\tnew ThymeleafRule('ScopedVariable',\n\t\tSequence('Identifier', /=/, 'Expression'),\n\t\t([name, , expression]) => context => ({\n\t\t\tname: name(context),\n\t\t\tvalue: expression(context)\n\t\t})\n\t),\n\n\t// Literals\n\t// ========\n\n\tnew ThymeleafRule('Literal',\n\t\tOrderedChoice(\n\t\t\t'StringLiteral',\n\t\t\t'NumberLiteral',\n\t\t\t'BooleanLiteral',\n\t\t\t'NullLiteral'\n\t\t)\n\t),\n\n\t/**\n\t * String literal, characters surrounded by `'` (single quotes).\n\t * \n\t * This is trying to emulate negative lookbehind so that escaped quotes don't\n\t * get counted as string terminators, but JavaScript only got that feature in\n\t * ES2018, so if I used it it'd leave too many JS engines without support.\n\t */\n\tnew ThymeleafRule('StringLiteral', /'.*?(?!\\\\').'/, result => () => result.slice(1, -1).replace(/\\\\/g, '')),\n\n\t/**\n\t * A number.\n\t */\n\tnew ThymeleafRule('NumberLiteral', /\\d+(\\.\\d+)?/, result => () => parseFloat(result)),\n\n\t/**\n\t * One of `true` or `false`.\n\t */\n\tnew ThymeleafRule('BooleanLiteral', /(true|false)/, result => () => result === 'true'),\n\n\t/**\n\t * The word `null` to represent the null value.\n\t */\n\t// TODO: The parser uses null to mean 'failed parse', so this might not work?\n\tnew ThymeleafRule('NullLiteral', /null/, () => () => null),\n\n\t/**\n\t * A token literal, which is pretty much anything else that can't be categorized\n\t * by the other literal types.  This is often used as a fallback in the\n\t * expression language so that, for any unknown input, we're still returning\n\t * something.\n\t */\n\tnew ThymeleafRule('TokenLiteral', /[^: ${}]+/, result => () => result),\n\n\n\t// Text operations\n\t// ===============\n\n\n\t/**\n\t * String concatenation, `'...' + '...'` or even `${...} + ${...}`, the\n\t * joining of 2 expressions by way of the `+` operator.\n\t */\n\tnew ThymeleafRule('StringConcatenation',\n\t\tSequence('Concatenatable', OneOrMore(Sequence(/\\+/, 'Concatenatable'))),\n\t\t(values) => context => {\n\t\t\treturn flatten(values).filter(item => item !== '+').reduce((result, value) => {\n\t\t\t\treturn result + (typeof value === 'function' ? value(context) : value);\n\t\t\t}, '');\n\t\t}\n\t),\n\tnew ThymeleafRule('Concatenatable',\n\t\tOrderedChoice(\n\t\t\t'StringLiteral',\n\t\t\t'VariableExpression'\n\t\t)\n\t),\n\n\tnew ThymeleafRule('LiteralSubstitution', Sequence(/^\\|/, OneOrMore(Sequence(/[^$|]*/, 'VariableExpression', /[^$|]*/)), /\\|$/), ([, matchers]) => context => {\n\t\treturn flatten(matchers).reduce((curr, acc) => {\n\t\t\tif (typeof acc === 'string') {\n\t\t\t\treturn curr + acc;\n\t\t\t}\n\t\t\treturn curr + acc(context);\n\t\t}, '');\n\t}),\n\n\n\t// Arithmetic operations\n\t// =====================\n\n\n\t// Boolean operations\n\t// ==================\n\n\tnew ThymeleafRule('LogicalOperation',\n\t\tOrderedChoice('LogicalAndOperation', 'LogicalOrOperation')\n\t),\n\tnew ThymeleafRule('LogicalAndOperation',\n\t\tSequence('Expression', 'LogicalAndOperator', 'Expression'),\n\t\t([leftOperand, , rightOperand]) => context => {\n\t\t\tlet lhs = leftOperand(context);\n\t\t\tlet rhs = rightOperand(context);\n\t\t\treturn lhs && rhs;\n\t\t}\n\t),\n\tnew ThymeleafRule('LogicalAndOperator',\n\t\tOrderedChoice(/&&/, /and/)\n\t),\n\tnew ThymeleafRule('LogicalOrOperation',\n\t\tSequence('Expression', 'LogicalOrOperator', 'Expression'),\n\t\t([leftOperand, , rightOperand]) => context => {\n\t\t\tlet lhs = leftOperand(context);\n\t\t\tlet rhs = rightOperand(context);\n\t\t\treturn lhs || rhs;\n\t\t}\n\t),\n\tnew ThymeleafRule('LogicalOrOperator',\n\t\tOrderedChoice(/\\|\\|/, /or/)\n\t),\n\n\tnew ThymeleafRule('Negation', /!/),\n\n\n\t// Comparisons and equality\n\t// ========================\n\n\t/**\n\t * An operation for comparing the equality of each side of the operator.\n\t */\n\tnew ThymeleafRule('EqualityOperation',\n\t\tSequence('Expression', 'EqualityOperator', 'Expression'),\n\t\t([leftOperand, operator, rightOperand]) => context => {\n\t\t\tlet lhs = leftOperand(context);\n\t\t\tlet rhs = rightOperand(context);\n\t\t\tswitch (operator(context)) {\n\t\t\t\tcase '==':  return lhs == rhs; // eslint-disable-line\n\t\t\t\tcase 'eq':\n\t\t\t\tcase '===': return lhs === rhs;\n\t\t\t\tcase '!=':  return lhs != rhs; // eslint-disable-line\n\t\t\t\tcase 'ne':\n\t\t\t\tcase '!==': return lhs !== rhs;\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t),\n\tnew ThymeleafRule('EqualityOperator',\n\t\tOrderedChoice(/[=!]==?/, /eq/, /ne/)\n\t),\n\n\n\t// Conditional operators\n\t// =====================\n\n\t/**\n\t * A logical expression is any expression that resolves to a `true`/`false`\n\t * value.\n\t */\n\tnew ThymeleafRule('LogicalExpression',\n\t\tOrderedChoice(\n\t\t\t'EqualityOperation',\n\t\t\t'LogicalOperation',\n\t\t\t'Expression'\n\t\t)\n\t),\n\n\t/**\n\t * If-then condition, `if ? then`.  This is the truthy branch only of the\n\t * classic ternary operator.  The falsey branch is a no-op.\n\t */\n\tnew ThymeleafRule('IfThenCondition',\n\t\tSequence('LogicalExpression', /\\?/, 'Expression'),\n\t\t([condition, , truthyExpression]) => context => {\n\t\t\treturn condition(context) ? truthyExpression(context) : undefined;\n\t\t}\n\t),\n\n\t/**\n\t * If-then-else condition, `if ? then : else`, the classic ternary operator.\n\t */\n\tnew ThymeleafRule('IfThenElseCondition',\n\t\tSequence('LogicalExpression', /\\?/, 'Expression', /:/, 'Expression'),\n\t\t([condition, , truthyExpression, , falseyExpression]) => context => {\n\t\t\treturn condition(context) ? truthyExpression(context) : falseyExpression(context);\n\t\t}\n\t),\n\n\n\t// Special tokens\n\t// ==============\n\n\t/**\n\t * An expression that matches the empty string.\n\t */\n\tnew ThymeleafRule('Nothing', /^$/),\n\n\n\t// Common language basics\n\t// ======================\n\n\tnew ThymeleafRule('Identifier', /[#a-zA-Z_][\\w]*/),\n\tnew ThymeleafRule('PropertyName', 'Identifier',\n\t\t(propertyName) => context => {\n\t\t\tlet property = propertyName(context);\n\t\t\treturn Object.prototype.hasOwnProperty.call(context, property) ? context[property] : '';\n\t\t}\n\t),\n\tnew ThymeleafRule('ArrayIndex', /([\\w]+)?(\\[[\\d]*])+/,\n\t\t(path) => context => {\n\t\t\treturn getByPath(context, path);\n\t\t}\n\t),\n\tnew ThymeleafRule('MethodCall',\n\t\tSequence('MethodName', /\\(/, Optional('MethodParameters'), /\\)/),\n\t\t([name, , parameters]) => (context, parameterContext) => {\n\t\t\tlet methodName = name(context);\n\t\t\tlet method = context[methodName];\n\t\t\tif (!method) {\n\t\t\t\tconsole.warn(`No method '${methodName}' present on the current context.  Expression: ${context.expression}`);\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\treturn method.apply(context, parameters(parameterContext || context));\n\t\t}\n\t),\n\tnew ThymeleafRule('MethodName', 'Identifier'),\n\tnew ThymeleafRule('MethodParameters',\n\t\tSequence('Chain', ZeroOrMore(Sequence(/,/, 'Chain'))),\n\t\t(parametersAndSeparators) => context => {\n\t\t\treturn parametersAndSeparators ?\n\t\t\t\tflatten(parametersAndSeparators)\n\t\t\t\t\t.filter(item => item !== ',')\n\t\t\t\t\t.map(parameter => parameter(context)) :\n\t\t\t\t[];\n\t\t}\n\t),\n\n\t/**\n\t * Any valid unit of code that resolves to some value.\n\t */\n\tnew ThymeleafRule('Expression',\n\t\tOrderedChoice(\n\t\t\t'LiteralSubstitution',\n\t\t\t'VariableExpression',\n\t\t\t'StringConcatenation',\n\t\t\t'Literal'\n\t\t)\n\t)\n);\n\nexport default ThymeleafExpressionLanguage;\n","/* \n * Copyright 2018, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Convert a standard node callback-style function into a function that returns\n * a Promise.\n * \n * @param {Function} func\n * @return {Function}\n */\nexport function promisify(func) {\n\treturn function() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tfunc(...arguments, (error, result) => {\n\t\t\t\tif (error) {\n\t\t\t\t\treject(new Error(result));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n}\n","/* \n * Copyright 2017, Emanuel Rabina (http://www.ultraq.net.nz/)\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *     http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {DEFAULT_CONFIGURATION}     from './Configurations.js';\nimport AttributeProcessor          from './processors/AttributeProcessor.js';\nimport ElementProcessor            from './processors/ElementProcessor.js';\nimport Matcher                     from './processors/Matcher.js';\nimport ExpressionProcessor         from './standard/expressions/ExpressionProcessor.js';\nimport FragmentSignatureGrammar    from './standard/expressions/FragmentSignatureGrammar.js';\nimport ThymeleafExpressionLanguage from './standard/expressions/ThymeleafExpressionLanguage.js';\nimport {deserialize, serialize}    from './utilities/Dom.js';\nimport {promisify}                 from './utilities/Functions.js';\n\nimport {readFile} from 'fs';\n\n/**\n * A highly-configurable class responsible for processing the Thymeleaf\n * directives found in HTML documents and fragments.\n * \n * @author Emanuel Rabina\n */\nexport default class TemplateEngine {\n\n\t/**\n\t * Constructor, set up a new template engine instance.\n\t * \n\t * @param {Object} [config=DEFAULT_CONFIGURATION]\n\t */\n\tconstructor({dialects, messageResolver, templateResolver} = DEFAULT_CONFIGURATION) {\n\n\t\tthis.messageResolver  = messageResolver;\n\t\tthis.templateResolver = templateResolver;\n\t\tthis.expressionProcessor = new ExpressionProcessor(ThymeleafExpressionLanguage);\n\t\tthis.fragmentSignatureProcessor = new ExpressionProcessor(FragmentSignatureGrammar);\n\n\t\t// Combine all processors into a unified list\n\t\tthis.processors = dialects.reduce((acc, {processors}) => processors ? [\n\t\t\t...acc,\n\t\t\t...processors\n\t\t] : acc, []);\n\n\t\t// Combine all expression objects into a unified object\n\t\tthis.expressionObjects = dialects.reduce((acc, {expressionObjects}) => expressionObjects ? {\n\t\t\t...acc,\n\t\t\t...expressionObjects\n\t\t} : acc, {});\n\t}\n\n\t/**\n\t * Process the Thymeleaf template data, returning the processed template.\n\t *\n\t * @param {String} template\n\t * @param {Object} [context={}]\n\t * @return {Promise<String>}\n\t *   A promise resolved with the processed template, or rejected with an error\n\t *   message.\n\t */\n\tprocess(template, context = {}) {\n\n\t\tlet documentFragment = deserialize(template);\n\t\tlet rootElement = documentFragment.firstElementChild;\n\t\treturn this.processNode(rootElement, {\n\t\t\t...context,\n\t\t\t...this.expressionObjects,\n\t\t\t// TODO: Is there some way to make these things a dependency of the\n\t\t\t//       processors that need them?  Otherwise it feels like passing\n\t\t\t//       dependencies as part of the context object \n\t\t\texpressionProcessor: this.expressionProcessor,\n\t\t\tfragmentSignatureProcessor: this.fragmentSignatureProcessor,\n\t\t\tmessageResolver:  this.messageResolver,\n\t\t\ttemplateResolver: this.templateResolver\n\t\t})\n\t\t\t.then(() => {\n\t\t\t\treturn serialize(documentFragment);\n\t\t\t});\n\t}\n\n\t/**\n\t * Process the Thymeleaf template at the given path, returning a promise of\n\t * the processed template.\n\t * \n\t * @param {String} filePath\n\t * @param {Object} [context={}]\n\t * @return {Promise<String>}\n\t *   A promise of the processed template.  The promise is immediately rejected\n\t *   if this method is called in a browser environment.\n\t */\n\tprocessFile(filePath, context = {}) {\n\n\t\t/* global ENVIRONMENT */\n\t\treturn ENVIRONMENT === 'browser' ?\n\t\t\tPromise.reject(new Error('Cannot use TemplateEngine.processFile() inside a browser')) :\n\t\t\tpromisify(readFile)(filePath)\n\t\t\t\t.then(data => {\n\t\t\t\t\treturn this.process(data, context);\n\t\t\t\t});\n\t}\n\n\t/**\n\t * Process a DOM element.\n\t * \n\t * @private\n\t * @param {Element} element\n\t * @param {Object} [context={}]\n\t * @return {Promise<Boolean>} Whether or not the parent node needs\n\t *   reprocessing.\n\t */\n\tasync processNode(element, context = {}) {\n\n\t\tlet localVariables = element.__thymeleafLocalVariables || {};\n\t\tlet localContext = {\n\t\t\t...context,\n\t\t\t...localVariables\n\t\t};\n\t\tlet matcher = new Matcher();\n\n\t\t// Run the current element through the gamut of registered processors.  If\n\t\t// one of them sends a reprocessing signal, return from this method to let\n\t\t// the caller re-run everything.\n\t\tfor (let i = 0; i < this.processors.length; i++) {\n\t\t\tlet processor = this.processors[i];\n\t\t\tlet processorResult = false;\n\n\t\t\tlet match = matcher.matches(element, processor);\n\t\t\tif (match) {\n\t\t\t\tif (processor instanceof AttributeProcessor) {\n\t\t\t\t\tprocessorResult = await processor.process(element, match,\n\t\t\t\t\t\telement.getAttribute(match), localContext);\n\t\t\t\t}\n\t\t\t\telse if (processor instanceof ElementProcessor) {\n\t\t\t\t\tprocessorResult = await processor.process(element, localContext);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (processorResult) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\t// Process this element's children, handling the reprocessing signal to\n\t\t// re-run the 'current' child element (could have been shifted due to being\n\t\t// removed etc).\n\t\tfor (let i = 0; i < element.children.length; ) {\n\t\t\tlet child = element.children[i];\n\t\t\tlet reprocess = await this.processNode(child, localContext);\n\t\t\tif (!reprocess) {\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\t}\n}\n"],"names":["AttributeProcessor","constructor","prefix","name","isomorphic","process","element","attribute","attributeValue","context","removeAttribute","NAME","AttrAttributeProcessor","test","split","forEach","value","processorResult","expressionProcessor","setAttribute","escapeHtml","JSON","stringify","env","NODE_ENV","console","warn","ElementProcessor","NODE_TYPE_DOCUMENT_TYPE","NODE_TYPE_ELEMENT","getThymeleafAttributeValue","processorName","getAttribute","deserialize","htmlString","JSDOM","window","document","serialize","documentFragment","result","firstChild","firstElementChild","nodeType","outerHTML","BlockElementProcessor","parent","parentElement","child","insertBefore","__thymeleafLocalVariables","removeChild","CheckedAttributeProcessor","ClassAppendAttributeProcessor","classes","className","EachAttributeProcessor","iterationInfo","localValueName","iterable","templateNode","cloneNode","localClone","appendChild","EmptyableAttributeProcessor","toString","EMPTYABLE_ATTRIBUTE_NAMES","FragmentAttributeProcessor","IfAttributeProcessor","expressionResult","remove","extractFragment","dialectPrefix","fragmentInfo","templateResolver","templateName","fragmentName","template","$","log","InsertAttributeProcessor","clearChildren","fragment","fragmentSignature","FragmentAttributeProcessorName","parameterNames","fragmentSignatureProcessor","parameters","localContext","parameterName","index","RemovableAttributeProcessor","REMOVABLE_ATTRIBUTE_NAMES","RemoveAttributeProcessor","lastElementChild","ReplaceAttributeProcessor","buildMessage","messageInfo","messageResolver","key","TextAttributeProcessor","messageResult","textContent","UnlessAttributeProcessor","parentNode","UTextAttributeProcessor","innerHTML","WithAttributeProcessor","localVariables","aliases","XmlNsAttributeProcessor","Dialect","expressionObjects","processors","DEFAULT_PREFIX","StandardDialect","map","attributeName","DEFAULT_CONFIGURATION","dialects","STANDARD_CONFIGURATION","Matcher","matches","processor","prefixes","unshift","hasAttribute","elementName","tagName","toUpperCase","InputBuffer","input","clear","lastPosition","positionStack","pop","undefined","Error","exhausted","position","length","mark","push","markAndClearOrReset","func","reset","read","pattern","remaining","substring","leadingWhitespace","match","RegExp","source","exec","startsWith","newPosition","Parser","grammar","parse","inputBuffer","matchResult","accept","errorMessage","error","parseWithExpression","expression","rule","findRuleByName","trackExpression","stackSize","expressionStack","splice","ExpressionProcessor","parser","AllInput","ruleName","defaultMatchProcessor","Rule","matchProcessor","ThymeleafRule","contextSensitiveMatchProcessor","args","apply","Grammar","startingRule","additionalRules","rules","concat","find","Optional","OneOrMore","results","OrderedChoice","expressions","Sequence","ZeroOrMore","namesAndSeparators","flatten","filter","item","RegularExpression","matchers","parseResults","i","parseResult","getByPath","obj","path","paths","getPathArray","requestedObject","Array","isArray","e","reduce","acc","el","replace","METADATA_FRAGMENT","METADATA_ITERATION","METADATA_MESSAGE","ThymeleafExpressionLanguage","chain","negation","link","linkContext","nextLink","messageKey","messageParameters","type","messageParameter","urlFunc","url","paramsList","slice","param","lhs","rhs","urlTemplate","head","placeholder","tail","paramEntry","join","expressionsAndSeparators","iterationStatusVariable","collectionExpressionAction","alias","parseFloat","values","curr","leftOperand","rightOperand","operator","condition","truthyExpression","falseyExpression","propertyName","property","Object","prototype","hasOwnProperty","call","parameterContext","methodName","method","parametersAndSeparators","parameter","promisify","Promise","resolve","reject","arguments","TemplateEngine","FragmentSignatureGrammar","rootElement","processNode","then","processFile","filePath","readFile","data","matcher","children","reprocess"],"mappings":"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"}